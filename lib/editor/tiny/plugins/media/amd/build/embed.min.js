define("tiny_media/embed",["exports","core/templates","core/str","core/modal_factory","core/modal_events","editor_tiny/utils","editor_tiny/options","./common","./embedmodal"],(function(_exports,_templates,_str,ModalFactory,ModalEvents,_utils,_options,_common,_embedmodal){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.MediaEmbed=void 0,_templates=_interopRequireDefault(_templates),ModalFactory=_interopRequireWildcard(ModalFactory),ModalEvents=_interopRequireWildcard(ModalEvents),_embedmodal=_interopRequireDefault(_embedmodal);const MEDIA_TYPES={LINK:"LINK",VIDEO:"VIDEO",AUDIO:"AUDIO"},TRACK_KINDS={SUBTITLES:"SUBTITLES",CAPTIONS:"CAPTIONS",DESCRIPTIONS:"DESCRIPTIONS",CHAPTERS:"CHAPTERS",METADATA:"METADATA"},CSS={FORM:"form.tiny_media_form",SOURCE:"tiny_media_source",TRACK:"tiny_media_track",MEDIA_SOURCE:"tiny_media_media_source",MEDIA_BROWSER:"openmediabrowser",LINK_SOURCE:"tiny_media_link_source",POSTER_SOURCE:"tiny_media_poster_source",TRACK_SOURCE:"tiny_media_track_source",DISPLAY_OPTIONS:"tiny_media_display_options",NAME_INPUT:"tiny_media_name_entry",TITLE_INPUT:"tiny_media_title_entry",URL_INPUT:"tiny_media_url_entry",POSTER_SIZE:"tiny_media_poster_size",LINK_SIZE:"tiny_media_link_size",WIDTH_INPUT:"tiny_media_width_entry",HEIGHT_INPUT:"tiny_media_height_entry",TRACK_KIND_INPUT:"tiny_media_track_kind_entry",TRACK_LABEL_INPUT:"tiny_media_track_label_entry",TRACK_LANG_INPUT:"tiny_media_track_lang_entry",TRACK_DEFAULT_SELECT:"tiny_media_track_default",MEDIA_CONTROLS_TOGGLE:"tiny_media_controls",MEDIA_AUTOPLAY_TOGGLE:"tiny_media_autoplay",MEDIA_MUTE_TOGGLE:"tiny_media_mute",MEDIA_LOOP_TOGGLE:"tiny_media_loop",ADVANCED_SETTINGS:"tiny_media_advancedsettings",INPUTSUBMIT:"tiny_media_submit",LINK:MEDIA_TYPES.LINK.toLowerCase(),VIDEO:MEDIA_TYPES.VIDEO.toLowerCase(),AUDIO:MEDIA_TYPES.AUDIO.toLowerCase(),TRACK_SUBTITLES:TRACK_KINDS.SUBTITLES.toLowerCase(),TRACK_CAPTIONS:TRACK_KINDS.CAPTIONS.toLowerCase(),TRACK_DESCRIPTIONS:TRACK_KINDS.DESCRIPTIONS.toLowerCase(),TRACK_CHAPTERS:TRACK_KINDS.CHAPTERS.toLowerCase(),TRACK_METADATA:TRACK_KINDS.METADATA.toLowerCase()},SELECTORS={SOURCE:".".concat(CSS.SOURCE),TRACK:".".concat(CSS.TRACK),MEDIA_SOURCE:".".concat(CSS.MEDIA_SOURCE),MEDIA_BROWSER:".".concat(CSS.MEDIA_BROWSER),POSTER_SOURCE:".".concat(CSS.POSTER_SOURCE),TRACK_SOURCE:".".concat(CSS.TRACK_SOURCE),DISPLAY_OPTIONS:".".concat(CSS.DISPLAY_OPTIONS),NAME_INPUT:".".concat(CSS.NAME_INPUT),TITLE_INPUT:".".concat(CSS.TITLE_INPUT),URL_INPUT:".".concat(CSS.URL_INPUT),POSTER_SIZE:".".concat(CSS.POSTER_SIZE),LINK_SIZE:".".concat(CSS.LINK_SIZE),WIDTH_INPUT:".".concat(CSS.WIDTH_INPUT),HEIGHT_INPUT:".".concat(CSS.HEIGHT_INPUT),TRACK_KIND_INPUT:".".concat(CSS.TRACK_KIND_INPUT),TRACK_LABEL_INPUT:".".concat(CSS.TRACK_LABEL_INPUT),TRACK_LANG_INPUT:".".concat(CSS.TRACK_LANG_INPUT),TRACK_DEFAULT_SELECT:".".concat(CSS.TRACK_DEFAULT_SELECT),MEDIA_CONTROLS_TOGGLE:".".concat(CSS.MEDIA_CONTROLS_TOGGLE),MEDIA_AUTOPLAY_TOGGLE:".".concat(CSS.MEDIA_AUTOPLAY_TOGGLE),MEDIA_MUTE_TOGGLE:".".concat(CSS.MEDIA_MUTE_TOGGLE),MEDIA_LOOP_TOGGLE:".".concat(CSS.MEDIA_LOOP_TOGGLE),ADVANCED_SETTINGS:".".concat(CSS.ADVANCED_SETTINGS),INPUTSUBMIT:".".concat(CSS.INPUTSUBMIT),LINK_TAB:'li[data-medium-type="'.concat(CSS.LINK,'"]'),LINK_PANE:'.tab-pane[data-medium-type="'.concat(CSS.LINK,'"]'),VIDEO_TAB:'li[data-medium-type="'.concat(CSS.VIDEO,'"]'),VIDEO_PANE:'.tab-pane[data-medium-type="'.concat(CSS.VIDEO,'"]'),AUDIO_TAB:'li[data-medium-type="'.concat(CSS.AUDIO,'"]'),AUDIO_PANE:'.tab-pane[data-medium-type="'.concat(CSS.AUDIO,'"]'),TRACK_SUBTITLES_TAB:'li[data-track-kind="'.concat(CSS.TRACK_SUBTITLES,'"]'),TRACK_SUBTITLES_PANE:'.tab-pane[data-track-kind="'.concat(CSS.TRACK_SUBTITLES,'"]'),TRACK_CAPTIONS_TAB:'li[data-track-kind="'.concat(CSS.TRACK_CAPTIONS,'"]'),TRACK_CAPTIONS_PANE:'.tab-pane[data-track-kind="'.concat(CSS.TRACK_CAPTIONS,'"]'),TRACK_DESCRIPTIONS_TAB:'li[data-track-kind="'.concat(CSS.TRACK_DESCRIPTIONS,'"]'),TRACK_DESCRIPTIONS_PANE:'.tab-pane[data-track-kind="'.concat(CSS.TRACK_DESCRIPTIONS,'"]'),TRACK_CHAPTERS_TAB:'li[data-track-kind="'.concat(CSS.TRACK_CHAPTERS,'"]'),TRACK_CHAPTERS_PANE:'.tab-pane[data-track-kind="'.concat(CSS.TRACK_CHAPTERS,'"]'),TRACK_METADATA_TAB:'li[data-track-kind="'.concat(CSS.TRACK_METADATA,'"]'),TRACK_METADATA_PANE:'.tab-pane[data-track-kind="'.concat(CSS.TRACK_METADATA,'"]')};_exports.MediaEmbed=class{constructor(editor){_defineProperty(this,"editor",null),_defineProperty(this,"canShowFilePicker",!0),this.editor=editor}async getTemplateContext(){const[addSourceHelpString,tracksHelpString,subtitlesHelpString,captionsHelpString,descriptionsHelpString,chaptersHelpString,metadataHelpString]=await(0,_str.get_strings)(["addsource_help","tracks_help","subtitles_help","captions_help","descriptions_help","chapters_help","metadata_help"].map((key=>({key:key,component:_common.component})))),languages=this.prepareMoodleLang();return{elementid:this.editor.getElement().id,CSS:CSS,showfilepicker:this.canShowFilePicker,addsourcehelpicon:{text:addSourceHelpString},trackshelpicon:{text:tracksHelpString},subtitleshelpicon:{text:subtitlesHelpString},captionshelpicon:{text:captionsHelpString},descriptionshelpicon:{text:descriptionsHelpString},chaptershelpicon:{text:chaptersHelpString},metadatahelpicon:{text:metadataHelpString},langsinstalled:languages.installed,langsavailable:languages.available}}async displayDialogue(){const modal=await ModalFactory.create({type:_embedmodal.default.TYPE,title:(0,_str.get_string)("createmedia","tiny_media"),templateContext:await this.getTemplateContext(),removeOnClose:!0,large:!0});this.applyMediumProperties(modal),this.registerEventListeners(modal),modal.show()}getSelectedMedia(){let mediaElm=this.editor.selection.getNode();return mediaElm?"video"===mediaElm.nodeName.toLowerCase()||"audio"===mediaElm.nodeName.toLowerCase()?mediaElm:mediaElm.querySelector("video")?mediaElm.querySelector("video"):mediaElm.querySelector("audio")?mediaElm.querySelector("audio"):null:null}getMediumProperties(){const boolAttr=(elem,attr)=>elem.hasAttribute(attr)&&(elem.getAttribute(attr)||""===elem.getAttribute(attr));let tracks={subtitles:[],captions:[],descriptions:[],chapters:[],metadata:[]},sources=[];const medium=this.getSelectedMedia();return medium?(medium.querySelectorAll("track").forEach((track=>{tracks[track.getAttribute("kind")].push({src:track.getAttribute("src"),srclang:track.getAttribute("srclang"),label:track.getAttribute("label"),defaultTrack:boolAttr(track,"default")})})),medium.querySelectorAll("source").forEach((source=>{sources.push(source.src)})),{type:"video"===medium.nodeName.toLowerCase()?MEDIA_TYPES.VIDEO:MEDIA_TYPES.AUDIO,sources:sources,poster:medium.getAttribute("poster"),title:medium.getAttribute("title"),width:medium.getAttribute("width"),height:medium.getAttribute("height"),autoplay:boolAttr(medium,"autoplay"),loop:boolAttr(medium,"loop"),muted:boolAttr(medium,"muted"),controls:boolAttr(medium,"controls"),tracks:tracks}):null}async applyMediumProperties(modal){await modal.getBody();const root=modal.getRoot()[0],properties=this.getMediumProperties();if(!properties)return;const applyTrackProperties=(track,properties)=>{track.querySelector(SELECTORS.TRACK_SOURCE+" "+SELECTORS.URL_INPUT).value=properties.src,track.querySelector(SELECTORS.TRACK_LANG_INPUT).value=properties.srclang,track.querySelector(SELECTORS.TRACK_LABEL_INPUT).value=properties.label,track.querySelector(SELECTORS.TRACK_DEFAULT_SELECT).checked=properties.defaultTrack},paneId="".concat(this.editor.getElement().id,"_").concat(properties.type.toLowerCase()),tabPane=root.querySelector(".root.tab-content > .tab-pane#".concat(paneId));tabPane.querySelector(SELECTORS.MEDIA_SOURCE+" "+SELECTORS.URL_INPUT).value=properties.sources[0],properties.sources.slice(1).forEach((source=>{this.addMediaSourceComponent(tabPane.querySelector(SELECTORS.MEDIA_SOURCE+" .addcomponent"),(newComponent=>{newComponent.querySelector(SELECTORS.URL_INPUT).value=source}))}));for(const[key,value]of Object.entries(properties.tracks)){const trackData=value.length?value:[{src:"",srclang:"",label:"",defaultTrack:!1}],paneSelector=SELECTORS["TRACK_"+key.toUpperCase()+"_PANE"];applyTrackProperties(tabPane.querySelector(paneSelector+" "+SELECTORS.TRACK),trackData[0]),trackData.slice(1).forEach((track=>{this.addTrackComponent(tabPane.querySelector(paneSelector+" "+SELECTORS.TRACK+" .addcomponent"),(newComponent=>{applyTrackProperties(newComponent,track)}))}))}tabPane.querySelector(SELECTORS.TITLE_INPUT).value=properties.title,tabPane.querySelector(SELECTORS.MEDIA_CONTROLS_TOGGLE).checked=properties.controls,tabPane.querySelector(SELECTORS.MEDIA_AUTOPLAY_TOGGLE).checked=properties.autoplay,tabPane.querySelector(SELECTORS.MEDIA_MUTE_TOGGLE).checked=properties.muted,tabPane.querySelector(SELECTORS.MEDIA_LOOP_TOGGLE).checked=properties.loop;const mediumType=this.getMediumTypeFromTabPane(tabPane);"video"===mediumType&&(tabPane.querySelector(SELECTORS.POSTER_SOURCE+" "+SELECTORS.URL_INPUT).value=properties.poster,tabPane.querySelector(SELECTORS.WIDTH_INPUT).value=properties.width,tabPane.querySelector(SELECTORS.HEIGHT_INPUT).value=properties.height),tabPane.parentElement.querySelector(".active").classList.remove("active"),root.querySelectorAll(".root.nav-tabs .nav-item a").forEach((item=>{item.classList.remove("active")})),tabPane.classList.add("active"),root.querySelector(SELECTORS[mediumType.toUpperCase()+"_TAB"]+" a").classList.add("active")}prepareMoodleLang(){const moodleLangs=(0,_options.getMoodleLang)(this.editor),currentLang=moodleLangs.currentlang;return{installed:Object.entries(moodleLangs.installed).map((_ref=>{let[lang,code]=_ref;return{lang:lang,code:code,default:lang===currentLang}})),available:Object.entries(moodleLangs.available).map((_ref2=>{let[lang,code]=_ref2;return{lang:lang,code:code,default:lang===currentLang}}))}}getMoodleLangObj(subtitleLang){const{available:available}=(0,_options.getMoodleLang)(this.editor);return available[subtitleLang]?{lang:subtitleLang,code:available[subtitleLang]}:null}filePickerCallback(params,element,fpType){if(""!==params.url){const tabPane=element.closest(".tab-pane");if(element.closest(SELECTORS.SOURCE).querySelector(SELECTORS.URL_INPUT).value=params.url,tabPane.id===this.editor.getElement().id+"_"+CSS.LINK&&(tabPane.querySelector(SELECTORS.NAME_INPUT).value=params.file),"subtitle"===fpType){const subtitleLang=params.file.split(".vtt")[0].split("-").slice(-1)[0],langObj=this.getMoodleLangObj(subtitleLang);if(langObj){const track=element.closest(SELECTORS.TRACK);track.querySelector(SELECTORS.TRACK_LABEL_INPUT).value=langObj.lang.trim(),track.querySelector(SELECTORS.TRACK_LANG_INPUT).value=langObj.code}}}}addMediaSourceComponent(element,callback){const sourceElement=element.closest(SELECTORS.SOURCE+SELECTORS.MEDIA_SOURCE),clone=sourceElement.cloneNode(!0);sourceElement.querySelector(".removecomponent-wrapper").classList.remove("hidden"),sourceElement.querySelector(".addcomponent-wrapper").classList.add("hidden"),sourceElement.parentNode.insertBefore(clone,sourceElement.nextSibling),callback&&callback(clone)}removeMediaSourceComponent(element){element.closest(SELECTORS.SOURCE+SELECTORS.MEDIA_SOURCE).remove()}addTrackComponent(element,callback){const trackElement=element.closest(SELECTORS.TRACK),clone=trackElement.cloneNode(!0);trackElement.querySelector(".removecomponent-wrapper").classList.remove("hidden"),trackElement.querySelector(".addcomponent-wrapper").classList.add("hidden"),trackElement.parentNode.insertBefore(clone,trackElement.nextSibling),callback&&callback(clone)}removeTrackComponent(element){element.closest(SELECTORS.TRACK).remove()}getMediumTypeFromTabPane(tabPane){return tabPane.getAttribute("data-medium-type")}getTrackTypeFromTabPane(tabPane){return tabPane.getAttribute("data-track-kind")}getMediaHTML(form){const mediumType=this.getMediumTypeFromTabPane(form.querySelector(".root.tab-content > .tab-pane.active")),tabContent=form.querySelector(SELECTORS[mediumType.toUpperCase()+"_PANE"]);return this["getMediaHTML"+mediumType[0].toUpperCase()+mediumType.substr(1)](tabContent)}getMediaHTMLLink(tab){const context={url:tab.querySelector(SELECTORS.URL_INPUT).value,name:tab.querySelector(SELECTORS.NAME_INPUT).value||!1};return context.url?_templates.default.renderForPromise("tiny_media/embed_media_link",context):""}getMediaHTMLVideo(tab){const context=this.getContextForMediaHTML(tab);return context.width=tab.querySelector(SELECTORS.WIDTH_INPUT).value||!1,context.height=tab.querySelector(SELECTORS.HEIGHT_INPUT).value||!1,context.poster=tab.querySelector(SELECTORS.POSTER_SOURCE+" "+SELECTORS.URL_INPUT).value||!1,context.sources.length?_templates.default.renderForPromise("tiny_media/embed_media_video",context):""}getMediaHTMLAudio(tab){let context=this.getContextForMediaHTML(tab);return context.sources.length?_templates.default.renderForPromise("tiny_media/embed_media_audio",context):""}getContextForMediaHTML(tab){const tracks=Array.from(tab.querySelectorAll(SELECTORS.TRACK)).map((track=>({track:track.querySelector(SELECTORS.TRACK_SOURCE+" "+SELECTORS.URL_INPUT).value,kind:this.getTrackTypeFromTabPane(track.closest(".tab-pane")),label:track.querySelector(SELECTORS.TRACK_LABEL_INPUT).value||track.querySelector(SELECTORS.TRACK_LANG_INPUT).value,srclang:track.querySelector(SELECTORS.TRACK_LANG_INPUT).value,defaultTrack:track.querySelector(SELECTORS.TRACK_DEFAULT_SELECT).checked?"true":null}))).filter((track=>!!track.track));return{sources:Array.from(tab.querySelectorAll(SELECTORS.MEDIA_SOURCE+" "+SELECTORS.URL_INPUT)).filter((source=>!!source.value)).map((source=>source.value)),description:tab.querySelector(SELECTORS.MEDIA_SOURCE+" "+SELECTORS.URL_INPUT).value||!1,tracks:tracks,showControls:tab.querySelector(SELECTORS.MEDIA_CONTROLS_TOGGLE).checked,autoplay:tab.querySelector(SELECTORS.MEDIA_AUTOPLAY_TOGGLE).checked,muted:tab.querySelector(SELECTORS.MEDIA_MUTE_TOGGLE).checked,loop:tab.querySelector(SELECTORS.MEDIA_LOOP_TOGGLE).checked,title:tab.querySelector(SELECTORS.TITLE_INPUT).value||!1}}getFilepickerTypeFromElement(element){return element.closest(SELECTORS.POSTER_SOURCE)?"image":element.closest(SELECTORS.TRACK_SOURCE)?"subtitle":"media"}async clickHandler(e){const element=e.target;if(element.closest(SELECTORS.MEDIA_BROWSER)){e.preventDefault();const fpType=this.getFilepickerTypeFromElement(element),params=await(0,_utils.displayFilepicker)(this.editor,fpType);this.filePickerCallback(params,element,fpType)}element.closest(SELECTORS.MEDIA_SOURCE+" .addcomponent")&&(e.preventDefault(),this.addMediaSourceComponent(element));element.closest(SELECTORS.MEDIA_SOURCE+" .removecomponent")&&(e.preventDefault(),this.removeMediaSourceComponent(element));element.closest(SELECTORS.TRACK+" .addcomponent")&&(e.preventDefault(),this.addTrackComponent(element));element.closest(SELECTORS.TRACK+" .removecomponent")&&(e.preventDefault(),this.removeTrackComponent(element));const trackDefaultAction=element.closest(SELECTORS.TRACK_DEFAULT_SELECT);if(trackDefaultAction&&trackDefaultAction.checked){const getKind=el=>this.getTrackTypeFromTabPane(el.parentElement.closest(".tab-pane"));element.parentElement.closest(".root.tab-content").querySelectorAll(SELECTORS.TRACK_DEFAULT_SELECT).forEach((select=>{select!==element&&getKind(element)===getKind(select)&&(select.checked=!1)}))}}async handleDialogueSubmission(event,modal){const{html:html}=await this.getMediaHTML(modal.getRoot()[0]);html&&this.editor.insertContent(html)}registerEventListeners(modal){const $root=modal.getRoot(),root=$root[0];this.canShowFilePicker&&root.addEventListener("click",this.clickHandler.bind(this)),$root.on(ModalEvents.save,this.handleDialogueSubmission.bind(this))}}}));

//# sourceMappingURL=embed.min.js.map