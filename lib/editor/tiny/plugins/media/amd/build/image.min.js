define("tiny_media/image",["exports","core/templates","core/str","core/modal_factory","core/modal_events","editor_tiny/utils"],(function(_exports,_templates,_str,Modal,ModalEvents,_utils){var obj;function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.MediaImage=void 0,_templates=(obj=_templates)&&obj.__esModule?obj:{default:obj},Modal=_interopRequireWildcard(Modal),ModalEvents=_interopRequireWildcard(ModalEvents);_exports.MediaImage=class{constructor(editor){_defineProperty(this,"CSS",{FORM:"form.tiny_image_form",RESPONSIVE:"img-fluid",INPUTALIGNMENT:"tiny_image_alignment",INPUTALT:"tiny_image_altentry",INPUTHEIGHT:"tiny_image_heightentry",INPUTSUBMIT:"tiny_image_urlentrysubmit",INPUTURL:"tiny_image_urlentry",INPUTSIZE:"tiny_image_size",INPUTWIDTH:"tiny_image_widthentry",IMAGEALTWARNING:"tiny_image_altwarning",IMAGEURLWARNING:"tiny_image_urlwarning",IMAGEBROWSER:"openimagebrowser",IMAGEPRESENTATION:"tiny_image_presentation",INPUTCONSTRAIN:"tiny_image_constrain",INPUTCUSTOMSTYLE:"tiny_image_customstyle",IMAGEPREVIEW:"tiny_image_preview",IMAGEPREVIEWBOX:"tiny_image_preview_box",ALIGNSETTINGS:"tiny_image_button"}),_defineProperty(this,"FORMNAMES",{URL:"urlentry",ALT:"altentry"}),_defineProperty(this,"REGEX",{ISPERCENT:/\d+%/}),_defineProperty(this,"DEFAULTS",{WIDTH:160,HEIGHT:160}),_defineProperty(this,"ALIGNMENTS",[{name:"verticalAlign",str:"alignment_top",value:"text-top",margin:"0 0.5em"},{name:"verticalAlign",str:"alignment_middle",value:"middle",margin:"0 0.5em"},{name:"verticalAlign",str:"alignment_bottom",value:"text-bottom",margin:"0 0.5em",isDefault:!0},{name:"float",str:"alignment_left",value:"left",margin:"0 0.5em 0 0"},{name:"float",str:"alignment_right",value:"right",margin:"0 0 0 0.5em"}]),_defineProperty(this,"form",null),_defineProperty(this,"rawImageDimensions",null),_defineProperty(this,"canShowFilePicker",!0),_defineProperty(this,"editor",null),_defineProperty(this,"currentModal",null),_defineProperty(this,"selectedImage",null),this.editor=editor}displayDialogue(){this.rawImageDimensions=null,Modal.create({type:Modal.types.DEFAULT,title:(0,_str.get_string)("imageproperties","tiny_media"),body:_templates.default.render("tiny_media/insert_image",{elementid:this.editor.getElement().id,CSS:this.CSS,FORMNAMES:this.FORMNAMES,showfilepicker:this.canShowFilePicker})}).then((modal=>(this.currentModal=modal,modal.getRoot().on(ModalEvents.bodyRendered,(()=>{this.form=document.querySelector(this.CSS.FORM),this.applyImageProperties(),this.registerEventListeners()})),modal.getRoot().on(ModalEvents.hidden,(()=>{modal.destroy()})),modal.show(),modal)))}filePickerCallback(params,self){if(""!==params.url){self.form.querySelector("."+self.CSS.INPUTURL).value=params.url,self.form.querySelector("."+self.CSS.INPUTWIDTH).value="",self.form.querySelector("."+self.CSS.INPUTHEIGHT).value="",self.loadPreviewImage(params.url)}}loadPreviewImage(url){const image=new Image;image.onerror=()=>{this.form.querySelector("."+CSS.IMAGEPREVIEW).style.display="none"},image.onload=()=>{let input,currentWidth,currentHeight,widthRatio,heightRatio;this.rawImageDimensions={width:image.width||this.DEFAULTS.WIDTH,height:image.height||this.DEFAULTS.HEIGHT},input=this.form.querySelector("."+this.CSS.INPUTWIDTH),currentWidth=input.value,""===currentWidth&&(input.value=this.rawImageDimensions.width,currentWidth=""+this.rawImageDimensions.width),input=this.form.querySelector("."+this.CSS.INPUTHEIGHT),currentHeight=input.value,""===currentHeight&&(input.value=this.rawImageDimensions.height,currentHeight=""+this.rawImageDimensions.height),input=this.form.querySelector("."+this.CSS.IMAGEPREVIEW),input.setAttribute("src",image.src),input.style.display="inline",input=this.form.querySelector("."+this.CSS.INPUTCONSTRAIN),currentWidth.match(this.REGEX.ISPERCENT)&&currentHeight.match(this.REGEX.ISPERCENT)?input.checked=currentWidth===currentHeight:0===image.width||0===image.height?input.disabled="disabled":(widthRatio=Math.round(1e3*parseInt(currentWidth,10)/image.width),heightRatio=Math.round(1e3*parseInt(currentHeight,10)/image.height),input.checked=widthRatio===heightRatio)},image.src=url}urlChanged(){const input=this.form.querySelector("."+this.CSS.INPUTURL);""!==input.value&&this.loadPreviewImage(input.value)}hasErrorUrlField(){const urlError=""===this.form.querySelector("."+this.CSS.INPUTURL).value;return this.toggleVisibility("."+this.CSS.IMAGEURLWARNING,urlError),this.toggleAriaInvalid(["."+this.CSS.INPUTURL],urlError),urlError}hasErrorAltField(){const alt=this.form.querySelector("."+this.CSS.INPUTALT).value,presentation=this.form.querySelector("."+this.CSS.IMAGEPRESENTATION).checked,imageAltError=""===alt&&!presentation;return this.toggleVisibility("."+this.CSS.IMAGEALTWARNING,imageAltError),this.toggleAriaInvalid(["."+this.CSS.INPUTALT,"."+this.CSS.IMAGEPRESENTATION],imageAltError),imageAltError}toggleVisibility(selector,predicate){this.form.querySelectorAll(selector).forEach((element=>{element.style.display=predicate?"block":"none"}))}toggleAriaInvalid(selectors,predicate){selectors.forEach((selector=>{this.form.querySelectorAll(selector).forEach((element=>{element.setAttribute("aria-invalid",predicate)}))}))}getAlignmentClass(alignment){return this.CSS.ALIGNSETTINGS+"_"+alignment}updateWarning(){const urlError=this.hasErrorUrlField(),imageAltError=this.hasErrorAltField();return urlError||imageAltError}setImage(e){const url=this.form.querySelector("."+this.CSS.INPUTURL).value,alt=this.form.querySelector("."+this.CSS.INPUTALT).value,width=this.form.querySelector("."+this.CSS.INPUTWIDTH).value,height=this.form.querySelector("."+this.CSS.INPUTHEIGHT).value,alignment=this.getAlignmentClass(this.form.querySelector("."+this.CSS.INPUTALIGNMENT).value),presentation=this.form.querySelector("."+this.CSS.IMAGEPRESENTATION).checked,constrain=this.form.querySelector("."+this.CSS.INPUTCONSTRAIN).value,customStyle=this.form.querySelector("."+this.CSS.INPUTCUSTOMSTYLE).value;let imageHtml,classList=[];if(e.preventDefault(),!this.updateWarning()&&""!==url){if(constrain&&classList.push(this.CSS.RESPONSIVE),classList.push(alignment),!width.match(this.REGEX.ISPERCENT)&&isNaN(parseInt(width,10)))return void this.form.querySelector("."+this.CSS.INPUTWIDTH).focus();if(!height.match(this.REGEX.ISPERCENT)&&isNaN(parseInt(height,10)))return void this.form.querySelector("."+this.CSS.INPUTHEIGHT).focus();_templates.default.render("tiny_media/image",{url:url,alt:alt,width:width,height:height,presentation:presentation,customstyle:customStyle,classlist:classList.join(" ")}).then((html=>{imageHtml=html,this.editor.insertContent(imageHtml),this.currentModal.destroy()}))}}handleKeyupCharacterCount(){const alt=this.form.querySelector("."+this.CSS.INPUTALT).value;this.form.querySelector("#currentcount").innerHTML=alt.length}autoAdjustSize(e,forceHeight){forceHeight=forceHeight||!1;let rawPercentage,rawSize,keyField=this.form.querySelector("."+this.CSS.INPUTWIDTH),keyFieldType="width",subField=this.form.querySelector("."+this.CSS.INPUTHEIGHT),subFieldType="height",constrainField=this.form.querySelector("."+this.CSS.INPUTCONSTRAIN),keyFieldValue=keyField.value,subFieldValue=subField.value,imagePreview=this.form.querySelector("."+this.CSS.IMAGEPREVIEW);if(this.rawImageDimensions)if(""===keyFieldValue&&(keyFieldValue=this.rawImageDimensions[keyFieldType],keyField.value=keyFieldValue,keyFieldValue=keyField.value),imagePreview.style.width=null,imagePreview.style.height=null,constrainField.checked){if(forceHeight){let temporaryValue;temporaryValue=keyField,keyField=subField,subField=temporaryValue,temporaryValue=keyFieldType,keyFieldType=subFieldType,subFieldType=temporaryValue,temporaryValue=keyFieldValue,keyFieldValue=subFieldValue,subFieldValue=temporaryValue}keyFieldValue.match(this.REGEX.ISPERCENT)?(subFieldValue=keyFieldValue,rawPercentage=parseInt(keyFieldValue,10),rawSize=this.rawImageDimensions.width/100*rawPercentage,imagePreview.style.width=rawSize,rawSize=this.rawImageDimensions.height/100*rawPercentage,imagePreview.style.height=rawSize):(subFieldValue=Math.round(keyFieldValue/this.rawImageDimensions[keyFieldType]*this.rawImageDimensions[subFieldType]),forceHeight?(imagePreview.style.width=subFieldValue,imagePreview.style.height=keyFieldValue):(imagePreview.style.width=keyFieldValue,imagePreview.style.height=subFieldValue)),subField.value=subFieldValue}else keyFieldValue.match(this.REGEX.ISPERCENT)?(rawPercentage=parseInt(keyFieldValue,10),rawSize=this.rawImageDimensions.width/100*rawPercentage,imagePreview.style.width=rawSize+"px"):imagePreview.style.width=keyFieldValue+"px",subFieldValue.match(this.REGEX.ISPERCENT)?(rawPercentage=parseInt(subFieldValue,10),rawSize=this.rawImageDimensions.height/100*rawPercentage,imagePreview.style.height=rawSize+"px"):imagePreview.style.height=subFieldValue+"px"}applyImageProperties(){const properties=this.getSelectedImageProperties(),img=this.form.querySelector("."+this.CSS.IMAGEPREVIEW);if(!1===properties)return img.style.display="none",void this.ALIGNMENTS.some((alignment=>!!alignment.isDefault&&(this.form.querySelector("."+this.CSS.INPUTALIGNMENT).value=alignment.value,!0)));properties.align&&(this.form.querySelector("."+this.CSS.INPUTALIGNMENT).value=properties.align),properties.customstyle&&(this.form.querySelector("."+this.CSS.INPUTCUSTOMSTYLE).value=properties.customstyle),properties.width&&(this.form.querySelector("."+this.CSS.INPUTWIDTH).value=properties.width),properties.height&&(this.form.querySelector("."+this.CSS.INPUTHEIGHT).value=properties.height),properties.alt&&(this.form.querySelector("."+this.CSS.INPUTALT).value=properties.alt),properties.src&&(this.form.querySelector("."+this.CSS.INPUTURL).value=properties.src,this.loadPreviewImage(properties.src)),properties.presentation&&(this.form.querySelector("."+this.CSS.IMAGEPRESENTATION).checked="checked"),this.autoAdjustSize()}getSelectedImageProperties(){let width,height,style,properties={src:null,alt:null,width:null,height:null,align:"",presentation:!1},image=this.getSelectedImage();return image?(image=this.removeLegacyAlignment(image),this.selectedImage=image,style=image.style,properties.customstyle=style,width=image.width,String(width).match(this.REGEX.ISPERCENT)||(width=parseInt(width,10)),height=image.height,String(height).match(this.REGEX.ISPERCENT)||(height=parseInt(height,10)),0!==width&&(properties.width=width),0!==height&&(properties.height=height),this.getAlignmentProperties(image,properties),properties.src=image.getAttribute("src"),properties.alt=image.getAttribute("alt")||"",properties.presentation="presentation"===image.getAttribute("role"),properties):(this.selectedImage=null,!1)}removeLegacyAlignment(imageNode){return imageNode.style.margin?(this.ALIGNMENTS.some((alignment=>{if(imageNode.style[alignment.name]!==alignment.value)return!1;const normalisedNode=document.createElement("div");return normalisedNode.style.margin=alignment.margin,imageNode.style.margin===normalisedNode.style.margin&&(imageNode.classList.add(this.getAlignmentClass(alignment.value)),imageNode.style[alignment.name]=null,imageNode.style.margin=null,!0)})),imageNode):imageNode}getAlignmentProperties(image,properties){let defaultAlignment,complete=!1;complete=this.ALIGNMENTS.some((alignment=>{const classname=this.getAlignmentClass(alignment.value);return image.classList.contains(classname)?(properties.align=alignment.value,!0):(alignment.isDefault&&(defaultAlignment=alignment.value),!1)})),!complete&&defaultAlignment&&(properties.align=defaultAlignment)}getSelectedImage(){const imgElm=this.editor.selection.getNode(),figureElm=this.editor.dom.getParent(imgElm,"figure.image");return figureElm?this.editor.dom.select("img",figureElm)[0]:imgElm&&("IMG"!==imgElm.nodeName||this.isPlaceholderImage(imgElm))?null:imgElm}isPlaceholderImage(imgElm){return"IMG"===imgElm.nodeName&&(imgElm.hasAttribute("data-mce-object")||imgElm.hasAttribute("data-mce-placeholder"))}registerEventListeners(){const self=this;this.form.querySelector("."+this.CSS.INPUTURL).addEventListener("blur",(()=>{this.urlChanged()})),this.form.querySelector("."+this.CSS.INPUTURL).addEventListener("change",(()=>{this.hasErrorUrlField()})),this.form.querySelector("."+this.CSS.IMAGEPRESENTATION).addEventListener("change",(()=>{this.hasErrorAltField()})),this.form.querySelector("."+this.CSS.INPUTALT).addEventListener("blur",(()=>{this.hasErrorAltField()})),this.form.querySelector("."+this.CSS.INPUTWIDTH).addEventListener("blur",(e=>{this.autoAdjustSize(e)})),this.form.querySelector("."+this.CSS.INPUTHEIGHT).addEventListener("blur",(e=>{this.autoAdjustSize(e,!0)})),this.form.querySelector("."+this.CSS.INPUTSUBMIT).addEventListener("click",(e=>{this.setImage(e)})),this.canShowFilePicker&&this.form.querySelector("."+this.CSS.IMAGEBROWSER).addEventListener("click",(e=>{e.preventDefault(),(0,_utils.displayFilepicker)(this.editor,"image").then((params=>{this.filePickerCallback(params,self)})).catch()})),this.form.querySelector("."+this.CSS.INPUTALT).addEventListener("keyup",(()=>{this.handleKeyupCharacterCount()}))}}}));

//# sourceMappingURL=image.min.js.map